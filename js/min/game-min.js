for(var nrPlayers=4,players=[],playerHands=[],cardPosition=0,round=1,turn=0,startPlayer=0,turnPlayer=0,stack=[],myDeck,trump,SOUND_dealingCard=new Audio("sounds/dealingCard.wav"),SOUND_tippCheck=new Audio("sounds/tippCheck.wav"),SOUND_distributeCards=new Audio("sounds/distributeCards.wav"),i=0;i<nrPlayers;i++){playerHands[i]=[];var nr=i+1;players[i]={name:"Spieler"+nr,points:0,tipp:"",actual:0}}require(["js/deck.js"],function(){var e=function(e,t,r,n){var a;if(console.log(N()),r==turnPlayer&&u(t,r,n)){var i=turn%nrPlayers;SOUND_dealingCard.currentTime=0,SOUND_dealingCard.play(),stack[i]=t,a=document.getElementById("stack-"+i),a.style.backgroundImage="url('img/CardDeck.png')",a.style.backgroundPosition=e.style.backgroundPosition,e.style.visibility="hidden",playerHands[r][n]=null,v(),H(),turn++}0!==turn&&turn%nrPlayers==0&&(players[d()].actual+=1,g(),setTimeout(function(){l()},500)),turn==nrPlayers*round&&setTimeout(function(){s(),H()},500)},t=function(e,t){for(var r="",n=4==nrPlayers?-3.2*e:-2.7*e,a=0;a<e;a++)playerHands[t][a]=myDeck.deck[cardPosition],cardPosition++,r+=a>0?'<div style="margin-left:'+n+'px" class="card card-'+t+'" id="card-pId'+t+"-cNr"+a+'"></div>':'<div class="card card-'+t+'" id="card-pId'+t+"-cNr"+a+'"></div>';return 3===t&&f(),r},r=function(){for(var t=0;t<nrPlayers;t++)for(var r=0;r<round;r++)!function(){var n=document.getElementById("card-pId"+t+"-cNr"+r),a=playerHands[t][r],i=t,s=r;n.style.backgroundPosition=a.x*-68+"px "+a.y*-96+"px",n.addEventListener("click",function(){e(this,a,i,s)})}()},n=function(e,n){SOUND_distributeCards.play();for(var a="",i=0;i<e;i++)a+='<div class="playerHand" id ="playerHand-'+i+'"><div class="tipp-container"><input class="tipp" id="tipp-'+i+'" type="number" placeholder="0" min="0" max='+round+'><button id="tipp-btn-'+i+'">Tipp</button></div>'+t(n,i)+"</div>";document.getElementById("field").innerHTML=a,r()},a=function(e){for(var t=3;t>=e;t--)document.getElementById("stack-"+t).style.visibility="hidden"},i=function(){for(var e=document.getElementById("stats"),t=1;t<=nrPlayers;t++){var r=e.insertRow(t),n=r.insertCell(0),a=r.insertCell(1),i=r.insertCell(2),s=r.insertCell(3);n.innerHTML=players[t-1].name,a.innerHTML=players[t-1].points,s.innerHTML=players[t-1].actual}},s=function(){m(),b(),g(),cardPosition=0,turn=0,stack=[],myDeck.shuffle(3);for(var e=0;e<nrPlayers;e++)playerHands[e]=[],document.getElementById("stack-"+e).style.backgroundImage="none";turnPlayer=round%nrPlayers,k()&&(n(nrPlayers,round),I(),P("Eine neue Runde startet, eure Tipps bitte",!1))},l=function(){turnPlayer=d(),P("Spieler "+(turnPlayer+1)+" holt den Stich",!1),H();for(var e=0;e<nrPlayers;e++)document.getElementById("stack-"+e).style.backgroundImage="none",stack[e]=null},u=function(e,t,r){return E()?t===turnPlayer&&(void 0===stack[0]||"W"===e.rank||"N"===e.rank||(!(o(e,t)&&!p(e))||(pNr=t+1,P("Spieler "+pNr+", bitte bedienen!",!0),!1))):(P("Warte bis alle getippt haben",!0),!1)},o=function(e,t){if(null===stack[0])return!1;for(var r=0;r<playerHands[t].length;r++)if(null!==playerHands[t][r]&&playerHands[t][r].suit===stack[0].suit&&"W"!==playerHands[t][r].rank&&"N"!==playerHands[t][r].rank)return!0;return!1},p=function(e){return"W"==stack[0].rank||"N"==stack[0].rank||e.suit==stack[0].suit},d=function(){for(var e,t=-1,r,n=-1,a=y(),i=0;i<nrPlayers;i++){if("W"==stack[i].rank)return c(i);"N"!=trump.rank&&"W"!=trump.rank&&stack[i].suit==trump.suit&&stack[i].value>t&&(e=i,t=stack[i].value),a&&stack[i].suit==a.suit&&stack[i].value>n&&(r=i,n=stack[i].value)}if(t>=0)return c(e);if(n>=0)return c(r);for(var s=0;s<nrPlayers;s++)return c("N"!=stack[s]?s:0)},c=function(e){return(turnPlayer+e)%nrPlayers},y=function(){for(var e=0;e<nrPlayers;e++)if("N"!=stack[e].rank)return stack[e];return null},m=function(){for(var e=0;e<nrPlayers;e++)players[e].tipp===players[e].actual?players[e].points+=20+10*players[e].tipp:players[e].points-=10*Math.abs(players[e].tipp-players[e].actual)},f=function(){cardPosition<60?(trump=myDeck.deck[cardPosition],cardPosition++,document.getElementById("trump").style.backgroundPosition=trump.x*-68+"px "+trump.y*-96+"px"):(trump=myDeck.deck[0],trump.rank="N",document.getElementById("trump").style.backgroundImage="none")},k=function(){if(round<60/nrPlayers)return round++,document.getElementById("round").innerHTML=round,!0;B();for(var e=-1e3,t,r=0;r<nrPlayers;r++)players[r].points>e&&(e=players[r].points,t=r+1);return P("Das Spiel ist vorbei. Der Gewinner ist Spieler "+t+" mit "+e+" Punkten",!1),P("Ein neues Spiel startet, viel Glück",!1),round=1,document.getElementById("round").innerHTML=round,!1},v=function(){turnPlayer=(turnPlayer+1)%nrPlayers},g=function(){for(var e=document.getElementById("stats"),t=1;t<=nrPlayers;t++)e.rows[t].cells[1].innerHTML=players[t-1].points,e.rows[t].cells[2].innerHTML=players[t-1].tipp,e.rows[t].cells[3].innerHTML=players[t-1].actual},P=function(e,t){var r=document.getElementById("info").innerHTML;r=t?'<span style="color:red;"> '+e+"...</span><br>"+r:e+"...<br>"+r,document.getElementById("info").innerHTML=r},b=function(){for(var e=0;e<nrPlayers;e++)players[e].actual=0,players[e].tipp=""},h=function(e){SOUND_tippCheck.currentTime=0,SOUND_tippCheck.play(),pNr=e+1,players[e].tipp=Number(document.getElementById("tipp-"+e).value),P("Spieler "+pNr+" tippt "+players[e].tipp+" Stich(e)",!1),document.getElementById("tipp-"+e).style.visibility="hidden",document.getElementById("tipp-btn-"+e).style.visibility="hidden",g(),pNr=1+turnPlayer,E()&&P("Los geht's - Spieler "+pNr+" beginnt<br>.....",!1)},E=function(){for(var e=0;e<nrPlayers;e++)if(""===document.getElementById("tipp-"+e).style.visibility||"visible"===document.getElementById("tipp-"+e).style.visibility)return!1;return!0},I=function(){for(var e=0;e<nrPlayers;e++)document.getElementById("tipp-"+e).value="",document.getElementById("tipp-"+e).style.visibility="visible",document.getElementById("tipp-btn-"+e).style.visibility="visible",function(){var t=e;document.getElementById("tipp-btn-"+e).addEventListener("click",function(){h(t)})}()},S=function(){for(var e=0;e<nrPlayers;e++)!function(){var t=e;document.getElementById("tipp-btn-"+e).addEventListener("click",function(){h(t)})}()},H=function(){for(var e=0;e<nrPlayers;e++)document.getElementById("playerHand-"+e).style.backgroundColor=e==turnPlayer?"rgba(39, 174, 96, 0.7)":"rgba(165, 42, 42, 0.7)"},B=function(){xmlhttpSet=new XMLHttpRequest,xmlhttpSet.open("GET","set_highscores.php?pzero="+players[0].points+"&pone="+players[1].points+"&ptwo="+players[2].points+"&pthree="+players[3].points,!0),xmlhttpSet.onreadystatechange=function(){if(4==this.readyState&&200==this.status){var e=JSON.parse(this.responseText);document.getElementById("highscores").innerHTML="Highscores:</br>Spieler 1: "+e.player0+" - Spieler 2: "+e.player1+"</br>Spieler 3: "+e.player2+" - Spieler 4: "+e.player3}},xmlhttpSet.send()},N=function(){return{"Spielerhände":playerHands,"Karten aus Deck entnommen":cardPosition,Runde:round,Zug:turn,Startspieler:startPlayer,"Spieler ist dran":turnPlayer,"Stapel in der Mitte":stack}};k(),a(nrPlayers),n(nrPlayers,round),H(),S(),i(),P("Eine neue Runde startet, eure Tipps bitte",!1),B()});